rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users ──────────────────────────────────────────────
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
                   && request.auth.uid == userId
                   // reportCount is not writable by client
                   && !("reportCount" in request.resource.data
                        && request.resource.data.reportCount != resource.data.reportCount)
                   // phone, age, createdAt, uid are immutable after creation
                   && (resource == null || (
                        request.resource.data.phone == resource.data.phone
                        && request.resource.data.age == resource.data.age
                        && request.resource.data.createdAt == resource.data.createdAt
                        && request.resource.data.uid == resource.data.uid
                      ));

      // ── Blocks (sub-collection) ──────────────────────────
      match /blocks/{blockId} {
        allow read, write: if request.auth != null
                           && request.auth.uid == userId;
      }
    }

    // ── Green Lights ───────────────────────────────────────
    match /greenLights/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null
                                    && request.resource.data.userId == request.auth.uid;

      // ── Private sub-collection (server-only) ─────────────
      match /private/{privateId} {
        allow read, write: if false;
      }
    }

    // ── Waves ──────────────────────────────────────────────
    match /waves/{waveId} {
      allow read: if request.auth != null
                  && (resource.data.fromUserId == request.auth.uid
                      || resource.data.toUserId == request.auth.uid);
      allow create: if request.auth != null
                    && request.resource.data.fromUserId == request.auth.uid;
      allow update: if request.auth != null
                    && resource.data.toUserId == request.auth.uid;
    }

    // ── Chat Rooms ─────────────────────────────────────────
    match /chatRooms/{chatRoomId} {
      allow read, write: if request.auth != null
                         && request.auth.uid in resource.data.participants;

      // ── Messages (sub-collection) ────────────────────────
      match /messages/{messageId} {
        allow read: if request.auth != null
                    && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participants;
        allow create: if request.auth != null
                      && request.auth.uid in get(/databases/$(database)/documents/chatRooms/$(chatRoomId)).data.participants
                      && request.resource.data.senderId == request.auth.uid;
      }
    }

    // ── Reports (write-only by reporter) ───────────────────
    match /reports/{reportId} {
      allow read: if false;
      allow create: if request.auth != null
                    && request.resource.data.reporterId == request.auth.uid;
    }

    // ── Feedback (write-only by author) ────────────────────
    match /feedback/{feedbackId} {
      allow read: if false;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
    }
  }
}
